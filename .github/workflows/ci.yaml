name: CI - Rick & Morty DevOps Pipeline

on:
  push:
    branches:
      - main

jobs:
  build-deploy-test:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Set up Docker
      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      # 3. Install kubectl
      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.29.0

      # 4. Install kind
      - name: Install kind
        uses: engineerd/setup-kind@v0.5.0
        with:
          version: v0.22.0

      # 5. Create kind cluster (only if not exists)
      - name: Create kind cluster
        run: |
          if ! kind get clusters | grep -q "^kind$"; then
            kind create cluster --name kind --wait 300s
          else
            echo "kind cluster already exists"
          fi

      # 6. Build Docker image
      - name: Build Docker image
        run: |
          docker build -t rick-morty-service:2.0 .

      # 7. Load Docker image into kind
      - name: Load Docker image into kind
        run: |
          kind load docker-image rick-morty-service:2.0 --name kind

      # 8. Install Helm
      - name: Install Helm
        uses: azure/setup-helm@v4

      # 9. Deploy application with Helm (Ingress disabled for CI)
      - name: Deploy Rick & Morty with Helm
        run: |
          helm upgrade --install rick-morty ./helm/rick-morty \
            --set image.repository=rick-morty-service \
            --set image.tag=2.0 \
            --set ingress.enabled=false

      # 10. Wait for deployment to be ready
      - name: Wait for application
        run: |
          kubectl rollout status deployment/rick-morty --timeout=120s

      # 11. Port-forward service
      - name: Port forward service
        run: |
          kubectl port-forward svc/rick-morty 8080:80 &
          sleep 10

      # 12. Test health endpoint
      - name: Test health endpoint
        run: |
          curl -f http://localhost:8080/health

      # 13. Test characters endpoint
      - name: Test characters endpoint
        run: |
          curl -f http://localhost:8080/characters
